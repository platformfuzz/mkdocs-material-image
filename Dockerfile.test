# Stage 0: Build the base image locally
FROM python:3.13-slim AS base-builder

WORKDIR /tmp

# Install mkdocs and mkdocs-material
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Stage 1: Build the documentation using the base image
FROM base-builder AS builder

WORKDIR /docs

# Copy the test documentation
COPY test/ /docs/

# Build the static site
RUN mkdocs build

# Stage 2: Serve the static site with nginx
FROM nginx:alpine

# Install wget for health check
RUN apk add --no-cache wget

# Copy the built site from builder stage
COPY --from=builder /docs/site /usr/share/nginx/html

# Create health check endpoint
RUN echo '{"status":"healthy"}' > /usr/share/nginx/html/health

# Configure nginx to listen on port 8000
RUN sed -i 's/listen       80;/listen       8000;/' /etc/nginx/conf.d/default.conf

# Expose port 8000 (same as base image)
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1
